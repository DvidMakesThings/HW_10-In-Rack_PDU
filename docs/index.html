<!-- index.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ENERGIS PDU Resources</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #1a1d23;
            --fg: #e4e4e4;
            --muted: #a9b1ba;
            --link: #88c0d0;
            --card: #22262e;
            --badge-green: #2e7d32;
            --badge-yellow: #b8860b;
            --badge-red: #8b0000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            padding: 2rem;
            line-height: 1.5;
            max-width: 1000px;
            margin: 0 auto;
        }

        a {
            color: var(--link);
            text-decoration: none;
        }

        a:hover {
            color: #fff;
        }

        h1 {
            margin-bottom: 0.25rem;
        }

        h2 {
            margin-top: 2rem;
        }

        p.desc {
            color: var(--muted);
            margin-top: 0.2rem;
        }

        .grid {
            display: grid;
            gap: 0.75rem;
        }

        .card {
            background: var(--card);
            border: 1px solid #2b3038;
            border-radius: 10px;
            padding: 0.85rem 1rem;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .title {
            font-weight: 600;
        }

        .muted {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .badge {
            display: inline-block;
            font-size: 0.75rem;
            border-radius: 999px;
            padding: 0.2rem 0.6rem;
            background: #2b3038;
            border: 1px solid #3a414c;
            text-transform: uppercase;
            letter-spacing: .02em;
        }

        .badge.html {
            border-color: #3a5f9a;
        }

        .badge.pdf {
            border-color: #6b3a3a;
        }

        .small {
            font-size: 0.85rem;
        }

        .section-header {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .divider {
            height: 1px;
            background: #2b3038;
            margin: 1rem 0;
            border: none;
        }

        .list {
            margin: 0.25rem 0 0 1.25rem;
        }

        .error {
            color: #ff6b6b;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <h1>ENERGIS PDU Resources</h1>
    <p class="desc">Manuals, specifications, and autogenerated test reports.</p>

    <div class="section-header">
        <h2>Manuals</h2>
    </div>
    <div class="card">
        <ul class="list">
            <li><a href="./Manuals/Programming_Manual.pdf" target="_blank">Programming Manual (PDF)</a></li>
            <li><a href="./Manuals/User_Manual.pdf" target="_blank">User Manual (PDF)</a></li>
        </ul>
    </div>

    <div class="section-header">
        <h2>Test Reports</h2>
        <span id="updated" class="muted small"></span>
    </div>
    <div id="tests" class="grid" aria-live="polite">
        <div class="card muted">Loading test index…</div>
    </div>

    <script>
        function esc(str) {
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[s]));
        }

        function formatDate(d) {
            try {
                const dt = (d instanceof Date) ? d : new Date(d);
                if (isNaN(dt)) return '';
                return dt.toLocaleDateString(undefined, {
                    year: 'numeric', month: 'short', day: '2-digit'
                });
            } catch {
                return '';
            }
        }

        function normalizeType(type, href) {
            const ext = (href || '').split('.').pop()?.toLowerCase();
            if (type) return type.toLowerCase();
            if (ext === 'html' || ext === 'htm') return 'html';
            if (ext === 'pdf') return 'pdf';
            return 'file';
        }

        function compareByDateDesc(a, b) {
            const da = Date.parse(a.date || a.updated || 0) || 0;
            const db = Date.parse(b.date || b.updated || 0) || 0;
            return db - da;
        }

        function renderReports(data) {
            const container = document.getElementById('tests');
            container.innerHTML = '';

            const reports = Array.isArray(data?.reports) ? data.reports.slice() : [];
            reports.sort(compareByDateDesc);

            if (!reports.length) {
                container.innerHTML = '<div class="card muted">No reports found in <code>/Test/tests.json</code>.</div>';
                return;
            }

            const updatedEl = document.getElementById('updated');
            if (data?.updated) {
                updatedEl.textContent = `Index updated: ${formatDate(data.updated)}`;
            } else {
                updatedEl.textContent = '';
            }

            for (const r of reports) {
                const href = String(r.href || '').trim();
                if (!href) continue;

                const title = r.title ? String(r.title).trim() : href.split('/').pop();
                const dateStr = r.date ? formatDate(r.date) : '';
                const t = normalizeType(r.type, href);

                const badge = `<span class="badge ${esc(t)}">${esc(t)}</span>`;
                const date = dateStr ? `<span class="muted small">${esc(dateStr)}</span>` : '';
                const size = (r.size && Number.isFinite(r.size))
                    ? `<span class="muted small"> • ${(r.size / 1024).toFixed(0)} KB</span>` : '';

                const li = document.createElement('div');
                li.className = 'card';
                li.innerHTML = `
                    <div class="row">
                        <div class="title">
                            <a href="./Test/${esc(href)}" target="_blank" rel="noopener">${esc(title)}</a>
                            ${size}
                        </div>
                        <div class="row">
                            ${date}
                            ${badge}
                        </div>
                    </div>
                    ${r.note ? `<div class="muted small" style="margin-top:.4rem">${esc(r.note)}</div>` : ''}
                `;
                container.appendChild(li);
            }
        }

        async function loadIndex() {
            const container = document.getElementById('tests');
            try {
                const res = await fetch('./Test/tests.json', { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                renderReports(json);
            } catch (e) {
                container.innerHTML = `
                    <div class="card">
                        <div class="error">Could not load <code>/Test/tests.json</code>.</div>
                        <div class="muted small" style="margin-top:.4rem">Ensure the file exists in your repository and is served by GitHub Pages.</div>
                    </div>
                `;
            }
        }

        loadIndex();
    </script>
</body>

</html>
